<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Chapter 40 Anomaly Detection | R for Audit Analytics</title>

    <meta name="author" content="Anil Goyal" />
  
   <meta name="description" content="This book is intended for auditors performing exploratory data analytics using R programming language, mainly Base R and Tidyverse." />
   <meta name="generator" content="placeholder" />
  <meta property="og:title" content="Chapter 40 Anomaly Detection | R for Audit Analytics" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://anilyayavar.github.io/new-book/" />
  <meta property="og:image" content="https://anilyayavar.github.io/new-book/images/cover.jpg" />
  <meta property="og:description" content="This book is intended for auditors performing exploratory data analytics using R programming language, mainly Base R and Tidyverse." />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 40 Anomaly Detection | R for Audit Analytics" />
  
  <meta name="twitter:description" content="This book is intended for auditors performing exploratory data analytics using R programming language, mainly Base R and Tidyverse." />
  <meta name="twitter:image" content="https://anilyayavar.github.io/new-book/images/cover.jpg" />
  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet" />
    <script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script>
    <script src="libs/bs3compat-0.8.0/transition.js"></script>
    <script src="libs/bs3compat-0.8.0/tabs.js"></script>
    <script src="libs/bs3compat-0.8.0/bs3compat.js"></script>
    <link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet" />
    <script src="libs/bs4_book-1.0.0/bs4_book.js"></script>
    <script src="libs/kePrint-0.0.1/kePrint.js"></script>
    <link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script>

  <!-- CSS -->
  <style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
    <style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
          margin-bottom: 0em;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
      <link rel="stylesheet" href="style.css" />
  
</head>

<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book">
    <a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R for Audit Analytics</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
      </form>

      <nav aria-label="Table of contents">
        <h2>Table of contents</h2>
        <div id="book-toc"></div>

        <div class="book-extra">
          <p><a id="book-repo" href="#">View book source <i class="fab fa-github"></i></a></li></p>
        </div>
      </nav>
    </div>
  </header>

  <main class="col-sm-12 col-md-9 col-lg-7" id="content">
<div id="anomaly-detection" class="section level1" number="40">
<h1><span class="header-section-number">Chapter 40</span> Anomaly Detection</h1>
<p>Anomalies play a significant role in the field of audit. As auditors start examining data whether it be financial statements, or transactions, or other relevant data, the detection of anomalies can provide valuable insights and help identify potential issues or irregularities. Anomalies often indicate the presence of fraudulent activities. Unusual or unexpected patterns in financial transactions or account balances may suggest potential fraud or misappropriation of assets. Auditors actively search for anomalies that may indicate fraudulent behavior, such as fictitious transactions, unauthorized access, or unusual changes in financial data.</p>
<p>Anomalies in the audit context serve as indicators of potential issues, including fraud, material misstatements, control weaknesses, compliance violations, and process inefficiencies. Detecting and investigating anomalies is crucial for auditors to provide accurate and reliable financial information, enhance internal controls, and support informed decision-making by stakeholders.</p>
<div id="definition-and-types-of-anomalies" class="section level2" number="40.1">
<h2><span class="header-section-number">40.1</span> Definition and types of anomalies</h2>
<p>Anomalies are patterns or data points that deviate significantly from the expected or normal behavior within a dataset. These are also known as outliers, novelties, or deviations and can provide valuable insights into unusual events or behavior in various domains.</p>
<p>Types of anomalies:</p>
<ul>
<li><p><strong>Point Anomalies:</strong> Individual data points that are considered anomalous when compared to the rest of the dataset. For example, a temperature sensor reading that is significantly different from the expected range.</p></li>
<li><p><strong>Contextual Anomalies:</strong> Data points that are considered anomalous within a specific context or subset of the dataset. For instance, a sudden increase in obsolete website traffic.</p></li>
<li><p><strong>Collective Anomalies:</strong> Groups of data points that exhibit anomalous behavior when analyzed together but might appear normal when considered individually. An example is a sudden drop in sales for multiple related products.</p></li>
</ul>
<p><strong>Anomaly detection, in R</strong></p>
</div>
<div id="anomaly-detection---by-inspection" class="section level2" number="40.2">
<h2><span class="header-section-number">40.2</span> Anomaly detection - by inspection</h2>
<p>Several times, anomalies or outliers are detectable by observation. The <code>summary()</code> function prints the <em>maximum</em>, <em>minimum</em>, <em>upper</em> and <em>lower quartiles</em>, and the <em>mean</em> and <em>median</em>, and can give a sense for how far an extreme point lies from the rest of the data. E.g. Let’s visualise the mean annual temperatures in degrees Fahrenheit in New Haven, Connecticut, from 1912 to 1971, through a boxplot (Refer Figure <a href="anomaly-detection.html#fig:an1">40.1</a>. This data is available in base R, as <code>nhtemp</code>.</p>
<div class="sourceCode" id="cb2105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2105-1"><a href="anomaly-detection.html#cb2105-1" tabindex="-1"></a><span class="fu">summary</span>(nhtemp)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   47.90   50.58   51.20   51.16   51.90   54.60</code></pre>
<p>The easiest way to get a sense for how unusual a particular value is is by using a graphical summary like a boxplot. In R, this is created using the <code>boxplot</code> function. The <code>boxplot</code> function takes a column of values as an input argument, here illustrated with the temperature data, and produces a box and whiskers representation of the distribution of the values. The extreme values are represented as distinct points, making them easier to spot. We can also make use of ggplot2. Examples from both base R and ggplot2 are shown in Figure <a href="anomaly-detection.html#fig:an1">40.1</a>.</p>
<div class="sourceCode" id="cb2107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2107-1"><a href="anomaly-detection.html#cb2107-1" tabindex="-1"></a><span class="fu">boxplot</span>(nhtemp, <span class="at">main =</span> <span class="st">&quot;Box plot of nhtemp data&quot;</span>)</span>
<span id="cb2107-2"><a href="anomaly-detection.html#cb2107-2" tabindex="-1"></a><span class="fu">ggplot</span>(iris, <span class="fu">aes</span>(Species, Petal.Length, <span class="at">color =</span> Species )) <span class="sc">+</span></span>
<span id="cb2107-3"><a href="anomaly-detection.html#cb2107-3" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.colour =</span> <span class="st">&quot;red&quot;</span>, <span class="at">outlier.size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb2107-4"><a href="anomaly-detection.html#cb2107-4" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb2107-5"><a href="anomaly-detection.html#cb2107-5" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Petal Lengths in Iris Data&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an1"></span>
<img src="DauR_files/figure-html/an1-1.png" alt="Outliers through Boxplot" width="45%" /><img src="DauR_files/figure-html/an1-2.png" alt="Outliers through Boxplot" width="45%" />
<p class="caption">
Figure 40.1: Outliers through Boxplot
</p>
</div>
<p>It’s important to note that a <strong>point anomaly</strong> is not necessarily always extreme. A point anomaly can also arise as an unusual combination of values across several attributes.</p>
<p>A <strong>collective anomaly</strong>, on the other hand, is a collection of similar data instances that can be considered anomalous together when compared to the rest of the data. For example, a consecutive 5 day period of high temperatures are shown by the red points in the plot. These daily temperatures are unusual because they occur together, and are likely caused by the same underlying weather event. Refer Figure <a href="anomaly-detection.html#fig:an2">40.2</a>.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an2"></span>
<img src="DauR_files/figure-html/an2-1.png" alt="Collective Anomalies" width="672" height="27%" />
<p class="caption">
Figure 40.2: Collective Anomalies
</p>
</div>
</div>
<div id="grubbs-test" class="section level2" number="40.3">
<h2><span class="header-section-number">40.3</span> Grubb’s Test</h2>
<p>We saw that visual assessment of outliers works well when the majority of data points are grouped together and rest of them lie separate. In statistics there are several tests to detect anomalies. <strong>Grubb’s Test</strong> is one of these. Grubb’s test assesses whether the point that lies farthest from the mean in a dataset could be an outlier. This point will either be the largest or smallest value in the data. This test is however based on assumption that data points are normally distributed. So before proceeding for this test, we must be sure that there is a plausible explanation for this assumption. <em>(We can check normality of data points by plotting a histogram. For other methods please refer to chapter on linear regression.)</em></p>
<p>Let’s run this test on <code>nhtemp</code> data example, which we have already seen in <a href="anomaly-detection.html#fig:an1">40.1</a> (Left). So let’s check its normality assumption.</p>
<div class="sourceCode" id="cb2108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2108-1"><a href="anomaly-detection.html#cb2108-1" tabindex="-1"></a><span class="fu">hist</span>(nhtemp, <span class="at">breaks =</span> <span class="dv">20</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an3"></span>
<img src="DauR_files/figure-html/an3-1.png" alt="Histogram for Grubb's test" width="672" height="27%" />
<p class="caption">
Figure 40.3: Histogram for Grubb’s test
</p>
</div>
<p>In figure <a href="anomaly-detection.html#fig:an3">40.3</a> we can see that our assumption is nearly satisfied. Let’s run the test.</p>
<div class="sourceCode" id="cb2109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2109-1"><a href="anomaly-detection.html#cb2109-1" tabindex="-1"></a><span class="fu">library</span>(outliers)</span>
<span id="cb2109-2"><a href="anomaly-detection.html#cb2109-2" tabindex="-1"></a>outliers<span class="sc">::</span><span class="fu">grubbs.test</span>(nhtemp)</span></code></pre></div>
<pre><code>## 
##  Grubbs test for one outlier
## 
## data:  nhtemp
## G = 2.71806, U = 0.87266, p-value = 0.1539
## alternative hypothesis: highest value 54.6 is an outlier</code></pre>
<p>As p value is <code>0.15</code> we do not have strong evidence to reject null hypothesis that extreme maximum value is an outlier.</p>
</div>
<div id="seasonal-hybrid-esd-algorithm" class="section level2" number="40.4">
<h2><span class="header-section-number">40.4</span> Seasonal Hybrid ESD Algorithm</h2>
<p>As we have seen that above test may not be appropriate for anomaly detection (normality assumption as well as detection of extreme values only), particularly detecting anomalies from a time series that may have seasonal variations. We may install <code>AnomalyDetection</code> package development version from github using <code>devtools::install_github("twitter/AnomalyDetection")</code>. Example: in <code>JohnsonJohnson</code> data having quarterly sales data, we can use the following syntax.</p>
<div class="sourceCode" id="cb2111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2111-1"><a href="anomaly-detection.html#cb2111-1" tabindex="-1"></a><span class="co">#devtools::install_github(&quot;twitter/AnomalyDetection&quot;)</span></span>
<span id="cb2111-2"><a href="anomaly-detection.html#cb2111-2" tabindex="-1"></a><span class="fu">library</span>(AnomalyDetection)</span>
<span id="cb2111-3"><a href="anomaly-detection.html#cb2111-3" tabindex="-1"></a><span class="fu">AnomalyDetectionVec</span>(<span class="fu">as.vector</span>(JohnsonJohnson), </span>
<span id="cb2111-4"><a href="anomaly-detection.html#cb2111-4" tabindex="-1"></a>                    <span class="at">period =</span> <span class="dv">4</span>, <span class="co"># Sesaonality</span></span>
<span id="cb2111-5"><a href="anomaly-detection.html#cb2111-5" tabindex="-1"></a>                    <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="co"># set FALSE when plot not needed</span></span>
<span id="cb2111-6"><a href="anomaly-detection.html#cb2111-6" tabindex="-1"></a>                    <span class="at">direction =</span> <span class="st">&#39;both&#39;</span> <span class="co"># set &#39;pos&#39; for higher values</span></span>
<span id="cb2111-7"><a href="anomaly-detection.html#cb2111-7" tabindex="-1"></a>                                       <span class="co"># or &#39;neg&#39; for lower values</span></span>
<span id="cb2111-8"><a href="anomaly-detection.html#cb2111-8" tabindex="-1"></a>                    )</span></code></pre></div>
<pre><code>## $anoms
##   index anoms
## 1    74 12.06
## 2    75 12.15
## 3    77 14.04
## 4    78 12.96
## 5    79 14.85
## 6    81 16.20
## 7    82 14.67
## 8    83 16.02
## 
## $plot</code></pre>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an4"></span>
<img src="DauR_files/figure-html/an4-1.png" alt="Seasonal Hybrid ESD Algorithm" width="672" height="28%" />
<p class="caption">
Figure 40.4: Seasonal Hybrid ESD Algorithm
</p>
</div>
<p>In Figure <a href="anomaly-detection.html#fig:an4">40.4</a>, we can see that in output <code>$anoms</code> containing anomalies are denoted in blue dots.</p>
</div>
<div id="k-nearest-neighbour-distance-score" class="section level2" number="40.5">
<h2><span class="header-section-number">40.5</span> k-Nearest Neighbour Distance Score</h2>
<p>One of greatest limitation of above two methods was that, these were applicable on univariate data series, whereas, in real world, data analysis will rarely be univariate. The <code>knn</code> technique works on multivariate data, but for visulaisation purposes, we will first visulaise the results on bivariate data only.</p>
<p><strong>K-Nearest Neighbour</strong> or <strong>KNN</strong> is a distance-based classifier, meaning that it implicitly assumes that the smaller the distance between two points, the more similar they are. For bivariate data, we can understand the algorithm by plotting the data-points in a two dimensional scatter plot. Now as the distance between any two points are usually calculated using <em>Euclidean Distance Metric</em>, we should ensure that the data is normalised/scaled before proceeding for distance calculation.</p>
<p><strong>Problem Statement-1:</strong> Let us try to identify outliers in <code>virginica</code> Species’ flower measurements. So let’s prepare the data. We will make use of <code>scale</code> function available in base R, to normalise the data. Remember that <code>scale</code> returns a matrix, so we may need to convert it into data.frame while using <code>ggplot2</code>.</p>
<div class="sourceCode" id="cb2113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2113-1"><a href="anomaly-detection.html#cb2113-1" tabindex="-1"></a><span class="co"># Sample data</span></span>
<span id="cb2113-2"><a href="anomaly-detection.html#cb2113-2" tabindex="-1"></a>df <span class="ot">&lt;-</span> iris[<span class="dv">101</span><span class="sc">:</span><span class="dv">150</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb2113-3"><a href="anomaly-detection.html#cb2113-3" tabindex="-1"></a><span class="co">#  Scale the data</span></span>
<span id="cb2113-4"><a href="anomaly-detection.html#cb2113-4" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">scale</span>(df)</span></code></pre></div>
<p>Let us visualise the data (in first two dimensions only). However, as our data is scaled already, we can try to visualise all the dimensions using a boxplot. See both figures in <a href="anomaly-detection.html#fig:an5">40.5</a>. The points/ouliers have been numbered (on the basis of row numbers) for interpretaion purposes.</p>
<div class="sourceCode" id="cb2114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2114-1"><a href="anomaly-detection.html#cb2114-1" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb2114-2"><a href="anomaly-detection.html#cb2114-2" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2114-3"><a href="anomaly-detection.html#cb2114-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb2114-4"><a href="anomaly-detection.html#cb2114-4" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(Sepal.Length, Sepal.Width)) <span class="sc">+</span></span>
<span id="cb2114-5"><a href="anomaly-detection.html#cb2114-5" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">&quot;seagreen&quot;</span>) <span class="sc">+</span></span>
<span id="cb2114-6"><a href="anomaly-detection.html#cb2114-6" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> row), <span class="at">arrow =</span> grid<span class="sc">::</span><span class="fu">arrow</span>()) <span class="sc">+</span></span>
<span id="cb2114-7"><a href="anomaly-detection.html#cb2114-7" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb2114-8"><a href="anomaly-detection.html#cb2114-8" tabindex="-1"></a></span>
<span id="cb2114-9"><a href="anomaly-detection.html#cb2114-9" tabindex="-1"></a><span class="co"># Helper Function</span></span>
<span id="cb2114-10"><a href="anomaly-detection.html#cb2114-10" tabindex="-1"></a>find_outlier <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2114-11"><a href="anomaly-detection.html#cb2114-11" tabindex="-1"></a>  <span class="fu">return</span>(x <span class="sc">&lt;</span> <span class="fu">quantile</span>(x, .<span class="dv">25</span>) <span class="sc">-</span> <span class="fl">1.5</span><span class="sc">*</span><span class="fu">IQR</span>(x) <span class="sc">|</span> x <span class="sc">&gt;</span> <span class="fu">quantile</span>(x, .<span class="dv">75</span>) <span class="sc">+</span> <span class="fl">1.5</span><span class="sc">*</span><span class="fu">IQR</span>(x))</span>
<span id="cb2114-12"><a href="anomaly-detection.html#cb2114-12" tabindex="-1"></a>}</span>
<span id="cb2114-13"><a href="anomaly-detection.html#cb2114-13" tabindex="-1"></a></span>
<span id="cb2114-14"><a href="anomaly-detection.html#cb2114-14" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb2114-15"><a href="anomaly-detection.html#cb2114-15" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2114-16"><a href="anomaly-detection.html#cb2114-16" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb2114-17"><a href="anomaly-detection.html#cb2114-17" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>row, <span class="at">names_to =</span> <span class="st">&quot;Dimension&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;Values&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2114-18"><a href="anomaly-detection.html#cb2114-18" tabindex="-1"></a>  <span class="fu">group_by</span>(Dimension) <span class="sc">%&gt;%</span> </span>
<span id="cb2114-19"><a href="anomaly-detection.html#cb2114-19" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">outlier =</span> <span class="fu">ifelse</span>(<span class="fu">find_outlier</span>(Values), row, <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb2114-20"><a href="anomaly-detection.html#cb2114-20" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(Dimension, Values)) <span class="sc">+</span></span>
<span id="cb2114-21"><a href="anomaly-detection.html#cb2114-21" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.colour =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb2114-22"><a href="anomaly-detection.html#cb2114-22" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span>outlier), <span class="at">na.rm=</span><span class="cn">TRUE</span>, <span class="at">hjust=</span><span class="sc">-</span>.<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb2114-23"><a href="anomaly-detection.html#cb2114-23" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an5"></span>
<img src="DauR_files/figure-html/an5-1.png" alt="Sepal Length Vs. Widths in Virginica" width="45%" /><img src="DauR_files/figure-html/an5-2.png" alt="Sepal Length Vs. Widths in Virginica" width="45%" />
<p class="caption">
Figure 40.5: Sepal Length Vs. Widths in Virginica
</p>
</div>
<p>Now, let’s proceed to identify outliers in R. We will make use of <code>get.knn</code> function from <code>FNN</code> package. However, <code>k</code> parameter is required beforehand.</p>
<div class="sourceCode" id="cb2115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2115-1"><a href="anomaly-detection.html#cb2115-1" tabindex="-1"></a><span class="co"># Load the library</span></span>
<span id="cb2115-2"><a href="anomaly-detection.html#cb2115-2" tabindex="-1"></a><span class="fu">library</span>(FNN)</span>
<span id="cb2115-3"><a href="anomaly-detection.html#cb2115-3" tabindex="-1"></a><span class="co"># get kNN object, using k = 5</span></span>
<span id="cb2115-4"><a href="anomaly-detection.html#cb2115-4" tabindex="-1"></a>viginica_knn <span class="ot">&lt;-</span> FNN<span class="sc">::</span><span class="fu">get.knn</span>(df[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="dv">5</span>)</span></code></pre></div>
<p>The <code>knn</code> object created above will have two sub-objects (both matrices having columns equal to chosen <code>k</code>), one having nearest neighbors’ indices and another having distances from those. Let’s view their top 6 rows.</p>
<div class="sourceCode" id="cb2116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2116-1"><a href="anomaly-detection.html#cb2116-1" tabindex="-1"></a><span class="fu">head</span>(viginica_knn<span class="sc">$</span>nn.index)</span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5]
## [1,]   37   16   49   11   45
## [2,]    2   15   22   35   14
## [3,]   30   40   42    8   13
## [4,]   34   27   29   33   28
## [5,]    5   17   46   38   41
## [6,]   36    8   30   23   31</code></pre>
<div class="sourceCode" id="cb2118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2118-1"><a href="anomaly-detection.html#cb2118-1" tabindex="-1"></a><span class="fu">head</span>(viginica_knn<span class="sc">$</span>nn.dist)</span></code></pre></div>
<pre><code>##           [,1]      [,2]      [,3]      [,4]      [,5]
## [1,] 0.3100808 0.3476803 0.3476803 0.4416741 0.6290499
## [2,] 0.0000000 0.3100808 0.4416741 0.5645648 0.6397904
## [3,] 0.1572625 0.4416741 0.4416741 0.4416741 0.4717874
## [4,] 0.3100808 0.3476803 0.3476803 0.3476803 0.4416741
## [5,] 0.0000000 0.0000000 0.3145250 0.3476803 0.4416741
## [6,] 0.1572625 0.5645648 0.6290499 0.6397904 0.6953605</code></pre>
<p>Using <code>rowMeans</code> we can calculate mean distance for each data point. The bigger this score is, the chances of that record being an outlier are relatively higher. Let’s also store that mean distance in a variable/column say <code>score</code> in main dataset, and visualise the results by setting the point-size with this mean distance (actually its square root). In Figure <a href="anomaly-detection.html#fig:an8">40.6</a>, we may notice that points lying far away are bigger becuase their chances of being outliers is high.</p>
<div class="sourceCode" id="cb2120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2120-1"><a href="anomaly-detection.html#cb2120-1" tabindex="-1"></a>score <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(viginica_knn<span class="sc">$</span>nn.dist)</span>
<span id="cb2120-2"><a href="anomaly-detection.html#cb2120-2" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb2120-3"><a href="anomaly-detection.html#cb2120-3" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2120-4"><a href="anomaly-detection.html#cb2120-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">row_number</span>(),</span>
<span id="cb2120-5"><a href="anomaly-detection.html#cb2120-5" tabindex="-1"></a>         <span class="at">score =</span> score) <span class="sc">%&gt;%</span> </span>
<span id="cb2120-6"><a href="anomaly-detection.html#cb2120-6" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(Sepal.Length, Sepal.Width)) <span class="sc">+</span></span>
<span id="cb2120-7"><a href="anomaly-detection.html#cb2120-7" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> score),<span class="at">color =</span> <span class="st">&quot;seagreen&quot;</span>) <span class="sc">+</span></span>
<span id="cb2120-8"><a href="anomaly-detection.html#cb2120-8" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> row), <span class="at">arrow =</span> grid<span class="sc">::</span><span class="fu">arrow</span>()) <span class="sc">+</span></span>
<span id="cb2120-9"><a href="anomaly-detection.html#cb2120-9" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb2120-10"><a href="anomaly-detection.html#cb2120-10" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;KNN method of outlier&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an8"></span>
<img src="DauR_files/figure-html/an8-1.png" alt="k-Nearest Neighbour Distance" width="672" height="28%" />
<p class="caption">
Figure 40.6: k-Nearest Neighbour Distance
</p>
</div>
<p>Now, we can run the algorithm to find the outlier on the basis of all variables in the dataset.</p>
<div class="sourceCode" id="cb2121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2121-1"><a href="anomaly-detection.html#cb2121-1" tabindex="-1"></a>virginica_knn <span class="ot">&lt;-</span> FNN<span class="sc">::</span><span class="fu">get.knn</span>(df, <span class="dv">5</span>)</span>
<span id="cb2121-2"><a href="anomaly-detection.html#cb2121-2" tabindex="-1"></a>score <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(virginica_knn<span class="sc">$</span>nn.dist)</span>
<span id="cb2121-3"><a href="anomaly-detection.html#cb2121-3" tabindex="-1"></a><span class="co"># Which point is farthest-Outlier</span></span>
<span id="cb2121-4"><a href="anomaly-detection.html#cb2121-4" tabindex="-1"></a><span class="fu">which.max</span>(score)</span></code></pre></div>
<pre><code>## [1] 32</code></pre>
</div>
<div id="local-outlier-factor" class="section level2" number="40.6">
<h2><span class="header-section-number">40.6</span> Local Outlier Factor</h2>
<p>As against kNN which uses distances of k neighbors, this algorithm uses density of each data point vis-a-vis density of its nearest neighbors. kNN distance seems to be good at detecting points that are really far from their neighbors, sometimes called global anomalies, but sometimes fail to capture all of the points that might be considered anomalous like local anomalies. Local Anomalies may lie near to a cluster still they won’t be like their neighbors. To understand it better, see the plot in Figure <a href="anomaly-detection.html#fig:an9">40.7</a> consisting of dummy data.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an9"></span>
<img src="DauR_files/figure-html/an9-1.png" alt="Local Outlier factor" width="672" height="28%" />
<p class="caption">
Figure 40.7: Local Outlier factor
</p>
</div>
<p>The red points may be global outliers, being far from its immediate neigbors, yet the blue points may be local anomalies as these are not like their immediate neighbors and may be local anomalies.</p>
<p>As stated, LOF segregates the data points based on the ratio of density of that point with that of densities of its neighbors. A score <code>&gt; 1</code> thus indicates that the data point may be an anomaly. Let’s see that on same problem statement.</p>
<div class="sourceCode" id="cb2123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2123-1"><a href="anomaly-detection.html#cb2123-1" tabindex="-1"></a><span class="fu">library</span>(dbscan)</span>
<span id="cb2123-2"><a href="anomaly-detection.html#cb2123-2" tabindex="-1"></a>lof_score <span class="ot">&lt;-</span> <span class="fu">lof</span>(df, <span class="dv">5</span>)</span>
<span id="cb2123-3"><a href="anomaly-detection.html#cb2123-3" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb2123-4"><a href="anomaly-detection.html#cb2123-4" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2123-5"><a href="anomaly-detection.html#cb2123-5" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">row_number</span>(),</span>
<span id="cb2123-6"><a href="anomaly-detection.html#cb2123-6" tabindex="-1"></a>         <span class="at">score =</span> lof_score) <span class="sc">%&gt;%</span> </span>
<span id="cb2123-7"><a href="anomaly-detection.html#cb2123-7" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(Sepal.Length, Sepal.Width)) <span class="sc">+</span></span>
<span id="cb2123-8"><a href="anomaly-detection.html#cb2123-8" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> score),<span class="at">color =</span> <span class="st">&quot;seagreen&quot;</span>) <span class="sc">+</span></span>
<span id="cb2123-9"><a href="anomaly-detection.html#cb2123-9" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> row), <span class="at">arrow =</span> grid<span class="sc">::</span><span class="fu">arrow</span>()) <span class="sc">+</span></span>
<span id="cb2123-10"><a href="anomaly-detection.html#cb2123-10" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">guide =</span> <span class="cn">FALSE</span>) <span class="sc">+</span>  </span>
<span id="cb2123-11"><a href="anomaly-detection.html#cb2123-11" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb2123-12"><a href="anomaly-detection.html#cb2123-12" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;LOF method of outlier&quot;</span>)</span>
<span id="cb2123-13"><a href="anomaly-detection.html#cb2123-13" tabindex="-1"></a></span>
<span id="cb2123-14"><a href="anomaly-detection.html#cb2123-14" tabindex="-1"></a>df_prcomp <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(df, <span class="at">scale. =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2123-15"><a href="anomaly-detection.html#cb2123-15" tabindex="-1"></a></span>
<span id="cb2123-16"><a href="anomaly-detection.html#cb2123-16" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb2123-17"><a href="anomaly-detection.html#cb2123-17" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2123-18"><a href="anomaly-detection.html#cb2123-18" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">row_number</span>(),</span>
<span id="cb2123-19"><a href="anomaly-detection.html#cb2123-19" tabindex="-1"></a>         <span class="at">score =</span> lof_score,</span>
<span id="cb2123-20"><a href="anomaly-detection.html#cb2123-20" tabindex="-1"></a>         <span class="at">PC1 =</span> df_prcomp<span class="sc">$</span>x[,<span class="dv">1</span>],</span>
<span id="cb2123-21"><a href="anomaly-detection.html#cb2123-21" tabindex="-1"></a>         <span class="at">PC2 =</span> df_prcomp<span class="sc">$</span>x[,<span class="dv">2</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb2123-22"><a href="anomaly-detection.html#cb2123-22" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(PC1, PC2)) <span class="sc">+</span></span>
<span id="cb2123-23"><a href="anomaly-detection.html#cb2123-23" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> score),<span class="at">color =</span> <span class="st">&quot;seagreen&quot;</span>) <span class="sc">+</span></span>
<span id="cb2123-24"><a href="anomaly-detection.html#cb2123-24" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> row), <span class="at">arrow =</span> grid<span class="sc">::</span><span class="fu">arrow</span>()) <span class="sc">+</span></span>
<span id="cb2123-25"><a href="anomaly-detection.html#cb2123-25" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">guide =</span> <span class="cn">FALSE</span>) <span class="sc">+</span>  </span>
<span id="cb2123-26"><a href="anomaly-detection.html#cb2123-26" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb2123-27"><a href="anomaly-detection.html#cb2123-27" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;LOF method of outlier</span><span class="sc">\n</span><span class="st">Visualised on principal components&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an10"></span>
<img src="DauR_files/figure-html/an10-1.png" alt="LOF" width="48%" /><img src="DauR_files/figure-html/an10-2.png" alt="LOF" width="48%" />
<p class="caption">
Figure 40.8: LOF
</p>
</div>
<p>Clearly, in Figure <a href="anomaly-detection.html#fig:an10">40.8</a> (left), where we have plotted the data in 2 dimensions only despite that we have attempted to find the LOF on the basis of all four dimensions. We can see presence of local anomalies, within the clustered data points. E.g. points nos. 31, 23, etc. were earlier given more weight instead of point nos.15, 10, etc. which are now given more weight. However, if we want to visaulise it on first two principal components, we can do that (Refer Figure <a href="anomaly-detection.html#fig:an10">40.8</a> (Right)). We can also verify this.</p>
<div class="sourceCode" id="cb2124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2124-1"><a href="anomaly-detection.html#cb2124-1" tabindex="-1"></a><span class="co"># Biggest Anomaly - kNN</span></span>
<span id="cb2124-2"><a href="anomaly-detection.html#cb2124-2" tabindex="-1"></a><span class="fu">which.max</span>(score)</span></code></pre></div>
<pre><code>## [1] 32</code></pre>
<div class="sourceCode" id="cb2126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2126-1"><a href="anomaly-detection.html#cb2126-1" tabindex="-1"></a><span class="co"># Biggest Anomaly - LOF</span></span>
<span id="cb2126-2"><a href="anomaly-detection.html#cb2126-2" tabindex="-1"></a><span class="fu">which.max</span>(lof_score)</span></code></pre></div>
<pre><code>## [1] 7</code></pre>
<p>Histograms of both <code>knn</code> and <code>LOF</code> scores can also be drawn, as in Figure <a href="anomaly-detection.html#fig:an12">40.9</a>.</p>
<div class="sourceCode" id="cb2128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2128-1"><a href="anomaly-detection.html#cb2128-1" tabindex="-1"></a><span class="fu">hist</span>(score, <span class="at">breaks =</span> <span class="dv">40</span>, </span>
<span id="cb2128-2"><a href="anomaly-detection.html#cb2128-2" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&quot;Histogram of KNN scores in IRIS-Virginica data&quot;</span>)</span>
<span id="cb2128-3"><a href="anomaly-detection.html#cb2128-3" tabindex="-1"></a><span class="fu">hist</span>(lof_score, <span class="at">breaks =</span> <span class="dv">40</span>, </span>
<span id="cb2128-4"><a href="anomaly-detection.html#cb2128-4" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&quot;Histogram of LOF scores in IRIS-Virginica data&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an12"></span>
<img src="DauR_files/figure-html/an12-1.png" alt="Histogram - KNN(Left) and LOF (Right)" width="48%" /><img src="DauR_files/figure-html/an12-2.png" alt="Histogram - KNN(Left) and LOF (Right)" width="48%" />
<p class="caption">
Figure 40.9: Histogram - KNN(Left) and LOF (Right)
</p>
</div>
</div>
<div id="isolation-treesforest" class="section level2" number="40.7">
<h2><span class="header-section-number">40.7</span> Isolation Trees/Forest</h2>
<p>Isolation Forest is an unsupervised tree based model, which actually works on path length instead of distance or density measures. Tree based models use decision tree(s) to determine the value/class of an observation given its value. In other words, it determines or try to identify a path from the root node to a leaf node based on the value of the observation in question. Forest (or Random Forest) are actually collection of smaller trees and thus using ensemble learning methods to make decision, instead of a single complex tree.</p>
<p>Let us work on the same problem statement above. Firstly, we will build a single decision tree. WE will use a development version package <code>isofor</code> which can be downloaded using <code>remotes::install_github("Zelazny7/isofor")</code>. To build forest/tree we will use function <code>iForest</code>. Its argument <code>nt</code> will determine the number of trees to be built in ensemble. Another important argument is <code>phi</code> which determines the number of samples to draw without replacement to construct each tree. So let’s use <code>nt = 1</code> and <code>phi = 100</code>.</p>
<div class="sourceCode" id="cb2129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2129-1"><a href="anomaly-detection.html#cb2129-1" tabindex="-1"></a><span class="co"># remotes::install_github(&quot;Zelazny7/isofor&quot;)</span></span>
<span id="cb2129-2"><a href="anomaly-detection.html#cb2129-2" tabindex="-1"></a><span class="fu">library</span>(isofor)</span>
<span id="cb2129-3"><a href="anomaly-detection.html#cb2129-3" tabindex="-1"></a><span class="co"># Generate a single tree</span></span>
<span id="cb2129-4"><a href="anomaly-detection.html#cb2129-4" tabindex="-1"></a><span class="co"># Specify number of samples explicitly</span></span>
<span id="cb2129-5"><a href="anomaly-detection.html#cb2129-5" tabindex="-1"></a>viginica_1 <span class="ot">&lt;-</span> <span class="fu">iForest</span>(df, <span class="at">nt =</span> <span class="dv">1</span>, <span class="at">phi =</span> <span class="dv">100</span>)</span>
<span id="cb2129-6"><a href="anomaly-detection.html#cb2129-6" tabindex="-1"></a></span>
<span id="cb2129-7"><a href="anomaly-detection.html#cb2129-7" tabindex="-1"></a><span class="co"># Generate isolation score</span></span>
<span id="cb2129-8"><a href="anomaly-detection.html#cb2129-8" tabindex="-1"></a>iso_score_1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(viginica_1, df)</span>
<span id="cb2129-9"><a href="anomaly-detection.html#cb2129-9" tabindex="-1"></a></span>
<span id="cb2129-10"><a href="anomaly-detection.html#cb2129-10" tabindex="-1"></a><span class="co"># View fisrt 10 scores</span></span>
<span id="cb2129-11"><a href="anomaly-detection.html#cb2129-11" tabindex="-1"></a>iso_score_1[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>##  [1] 0.3372822 0.3437950 0.3694749 0.4425250 0.3694749 0.4517359 0.8198250
##  [8] 0.6085593 0.4989121 0.6085593</code></pre>
<p><em>Score interpretations</em>: The closer the score is to 1, the more likely the point is an anomaly. However, if their scores are below 0.5, they are probably just normal points within the trend.</p>
<p>Let’s just visualise the scores on Principal Component plot again.</p>
<div class="sourceCode" id="cb2131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2131-1"><a href="anomaly-detection.html#cb2131-1" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb2131-2"><a href="anomaly-detection.html#cb2131-2" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2131-3"><a href="anomaly-detection.html#cb2131-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">row_number</span>(),</span>
<span id="cb2131-4"><a href="anomaly-detection.html#cb2131-4" tabindex="-1"></a>         <span class="at">score =</span> iso_score_1,</span>
<span id="cb2131-5"><a href="anomaly-detection.html#cb2131-5" tabindex="-1"></a>         <span class="at">PC1 =</span> df_prcomp<span class="sc">$</span>x[,<span class="dv">1</span>],</span>
<span id="cb2131-6"><a href="anomaly-detection.html#cb2131-6" tabindex="-1"></a>         <span class="at">PC2 =</span> df_prcomp<span class="sc">$</span>x[,<span class="dv">2</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb2131-7"><a href="anomaly-detection.html#cb2131-7" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(PC1, PC2)) <span class="sc">+</span></span>
<span id="cb2131-8"><a href="anomaly-detection.html#cb2131-8" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> score),<span class="at">color =</span> <span class="st">&quot;seagreen&quot;</span>) <span class="sc">+</span></span>
<span id="cb2131-9"><a href="anomaly-detection.html#cb2131-9" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> row), <span class="at">arrow =</span> grid<span class="sc">::</span><span class="fu">arrow</span>()) <span class="sc">+</span></span>
<span id="cb2131-10"><a href="anomaly-detection.html#cb2131-10" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">guide =</span> <span class="cn">FALSE</span>) <span class="sc">+</span>  </span>
<span id="cb2131-11"><a href="anomaly-detection.html#cb2131-11" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb2131-12"><a href="anomaly-detection.html#cb2131-12" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Isolation Tree based outlier</span><span class="sc">\n</span><span class="st">Visualised on principal components&quot;</span>)</span>
<span id="cb2131-13"><a href="anomaly-detection.html#cb2131-13" tabindex="-1"></a></span>
<span id="cb2131-14"><a href="anomaly-detection.html#cb2131-14" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb2131-15"><a href="anomaly-detection.html#cb2131-15" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2131-16"><a href="anomaly-detection.html#cb2131-16" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">row_number</span>(),</span>
<span id="cb2131-17"><a href="anomaly-detection.html#cb2131-17" tabindex="-1"></a>         <span class="at">score =</span> iso_score_1,</span>
<span id="cb2131-18"><a href="anomaly-detection.html#cb2131-18" tabindex="-1"></a>         <span class="at">PC1 =</span> df_prcomp<span class="sc">$</span>x[,<span class="dv">1</span>],</span>
<span id="cb2131-19"><a href="anomaly-detection.html#cb2131-19" tabindex="-1"></a>         <span class="at">PC2 =</span> df_prcomp<span class="sc">$</span>x[,<span class="dv">2</span>],</span>
<span id="cb2131-20"><a href="anomaly-detection.html#cb2131-20" tabindex="-1"></a>         <span class="at">is_outlier =</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(<span class="fu">ntile</span>(iso_score_1, <span class="dv">10</span>) <span class="sc">&gt;=</span> <span class="dv">10</span>, <span class="st">&quot;O&quot;</span>, <span class="st">&quot;N&quot;</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb2131-21"><a href="anomaly-detection.html#cb2131-21" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(PC1, PC2)) <span class="sc">+</span></span>
<span id="cb2131-22"><a href="anomaly-detection.html#cb2131-22" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> score, <span class="at">color =</span> is_outlier)) <span class="sc">+</span></span>
<span id="cb2131-23"><a href="anomaly-detection.html#cb2131-23" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> row), <span class="at">arrow =</span> grid<span class="sc">::</span><span class="fu">arrow</span>()) <span class="sc">+</span></span>
<span id="cb2131-24"><a href="anomaly-detection.html#cb2131-24" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="at">O =</span> <span class="st">&quot;red&quot;</span>, <span class="at">N =</span> <span class="st">&quot;black&quot;</span>), <span class="at">guide =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb2131-25"><a href="anomaly-detection.html#cb2131-25" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">guide =</span> <span class="cn">FALSE</span>) <span class="sc">+</span>  </span>
<span id="cb2131-26"><a href="anomaly-detection.html#cb2131-26" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb2131-27"><a href="anomaly-detection.html#cb2131-27" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Isolation Tree based outlier</span><span class="sc">\n</span><span class="st">Top-10%&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an24"></span>
<img src="DauR_files/figure-html/an24-1.png" alt="Isolation Tree Method" width="48%" /><img src="DauR_files/figure-html/an24-2.png" alt="Isolation Tree Method" width="48%" />
<p class="caption">
Figure 40.10: Isolation Tree Method
</p>
</div>
<p>Let’s also try a forest (ensemble) approach. Refer Figure <a href="anomaly-detection.html#fig:an14">40.11</a>, we can see that scores are modified using ensemble methods. However, when we gradually increase number of trees, these scores will stabilise.</p>
<div class="sourceCode" id="cb2132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2132-1"><a href="anomaly-detection.html#cb2132-1" tabindex="-1"></a>iso_100 <span class="ot">&lt;-</span> <span class="fu">iForest</span>(df, <span class="at">nt =</span> <span class="dv">100</span>, <span class="at">phi =</span> <span class="dv">100</span>)</span>
<span id="cb2132-2"><a href="anomaly-detection.html#cb2132-2" tabindex="-1"></a></span>
<span id="cb2132-3"><a href="anomaly-detection.html#cb2132-3" tabindex="-1"></a><span class="co"># Generate scores</span></span>
<span id="cb2132-4"><a href="anomaly-detection.html#cb2132-4" tabindex="-1"></a></span>
<span id="cb2132-5"><a href="anomaly-detection.html#cb2132-5" tabindex="-1"></a>iso_score_100 <span class="ot">&lt;-</span> <span class="fu">predict</span>(iso_100, df)</span>
<span id="cb2132-6"><a href="anomaly-detection.html#cb2132-6" tabindex="-1"></a></span>
<span id="cb2132-7"><a href="anomaly-detection.html#cb2132-7" tabindex="-1"></a><span class="co"># View Results</span></span>
<span id="cb2132-8"><a href="anomaly-detection.html#cb2132-8" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb2132-9"><a href="anomaly-detection.html#cb2132-9" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2132-10"><a href="anomaly-detection.html#cb2132-10" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">row_number</span>(),</span>
<span id="cb2132-11"><a href="anomaly-detection.html#cb2132-11" tabindex="-1"></a>         <span class="at">score =</span> iso_score_100,</span>
<span id="cb2132-12"><a href="anomaly-detection.html#cb2132-12" tabindex="-1"></a>         <span class="at">PC1 =</span> df_prcomp<span class="sc">$</span>x[,<span class="dv">1</span>],</span>
<span id="cb2132-13"><a href="anomaly-detection.html#cb2132-13" tabindex="-1"></a>         <span class="at">PC2 =</span> df_prcomp<span class="sc">$</span>x[,<span class="dv">2</span>],</span>
<span id="cb2132-14"><a href="anomaly-detection.html#cb2132-14" tabindex="-1"></a>         <span class="at">is_outlier =</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(<span class="fu">ntile</span>(iso_score_100, <span class="dv">10</span>) <span class="sc">&gt;=</span> <span class="dv">10</span>, <span class="st">&quot;O&quot;</span>, <span class="st">&quot;N&quot;</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb2132-15"><a href="anomaly-detection.html#cb2132-15" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(PC1, PC2)) <span class="sc">+</span></span>
<span id="cb2132-16"><a href="anomaly-detection.html#cb2132-16" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> score, <span class="at">color =</span> is_outlier)) <span class="sc">+</span></span>
<span id="cb2132-17"><a href="anomaly-detection.html#cb2132-17" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> row), <span class="at">arrow =</span> grid<span class="sc">::</span><span class="fu">arrow</span>()) <span class="sc">+</span></span>
<span id="cb2132-18"><a href="anomaly-detection.html#cb2132-18" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="at">O =</span> <span class="st">&quot;red&quot;</span>, <span class="at">N =</span> <span class="st">&quot;black&quot;</span>), <span class="at">guide =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb2132-19"><a href="anomaly-detection.html#cb2132-19" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">guide =</span> <span class="cn">FALSE</span>) <span class="sc">+</span>  </span>
<span id="cb2132-20"><a href="anomaly-detection.html#cb2132-20" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb2132-21"><a href="anomaly-detection.html#cb2132-21" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Isolation Tree based outlier</span><span class="sc">\n</span><span class="st">Number of Trees = 100&quot;</span>)</span>
<span id="cb2132-22"><a href="anomaly-detection.html#cb2132-22" tabindex="-1"></a></span>
<span id="cb2132-23"><a href="anomaly-detection.html#cb2132-23" tabindex="-1"></a><span class="fu">plot</span>(iso_score_1, iso_score_100, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb2132-24"><a href="anomaly-detection.html#cb2132-24" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&quot;Comparision of Tree Vs. Forest Method&quot;</span>)</span>
<span id="cb2132-25"><a href="anomaly-detection.html#cb2132-25" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an14"></span>
<img src="DauR_files/figure-html/an14-1.png" alt="100 Isolation Trees (Left) Comparison of 1 vs. 100 trees (Right)" width="48%" /><img src="DauR_files/figure-html/an14-2.png" alt="100 Isolation Trees (Left) Comparison of 1 vs. 100 trees (Right)" width="48%" />
<p class="caption">
Figure 40.11: 100 Isolation Trees (Left) Comparison of 1 vs. 100 trees (Right)
</p>
</div>
<p><strong>Contour plots:</strong> We can also visualise the results of scores of anomaly detection, using contour plots. See the plot in Figure <a href="anomaly-detection.html#fig:an16">40.12</a>.</p>
<div class="sourceCode" id="cb2133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2133-1"><a href="anomaly-detection.html#cb2133-1" tabindex="-1"></a><span class="co"># Create PRCOMP data</span></span>
<span id="cb2133-2"><a href="anomaly-detection.html#cb2133-2" tabindex="-1"></a>df_grid <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2133-3"><a href="anomaly-detection.html#cb2133-3" tabindex="-1"></a>  <span class="at">PC1 =</span> df_prcomp<span class="sc">$</span>x[,<span class="dv">1</span>],</span>
<span id="cb2133-4"><a href="anomaly-detection.html#cb2133-4" tabindex="-1"></a>  <span class="at">PC2 =</span> df_prcomp<span class="sc">$</span>x[,<span class="dv">2</span>]</span>
<span id="cb2133-5"><a href="anomaly-detection.html#cb2133-5" tabindex="-1"></a>)</span>
<span id="cb2133-6"><a href="anomaly-detection.html#cb2133-6" tabindex="-1"></a></span>
<span id="cb2133-7"><a href="anomaly-detection.html#cb2133-7" tabindex="-1"></a><span class="co"># Create Sequences</span></span>
<span id="cb2133-8"><a href="anomaly-detection.html#cb2133-8" tabindex="-1"></a>pc1_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(df_prcomp<span class="sc">$</span>x[,<span class="dv">1</span>]), <span class="fu">max</span>(df_prcomp<span class="sc">$</span>x[,<span class="dv">1</span>]), <span class="at">length.out =</span> <span class="dv">25</span>)</span>
<span id="cb2133-9"><a href="anomaly-detection.html#cb2133-9" tabindex="-1"></a>pc2_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(df_prcomp<span class="sc">$</span>x[,<span class="dv">2</span>]), <span class="fu">max</span>(df_prcomp<span class="sc">$</span>x[,<span class="dv">2</span>]), <span class="at">length.out =</span> <span class="dv">25</span>)</span>
<span id="cb2133-10"><a href="anomaly-detection.html#cb2133-10" tabindex="-1"></a><span class="co"># Create Grid</span></span>
<span id="cb2133-11"><a href="anomaly-detection.html#cb2133-11" tabindex="-1"></a>my_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">PC1 =</span> pc1_seq, <span class="at">PC2 =</span> pc2_seq)</span>
<span id="cb2133-12"><a href="anomaly-detection.html#cb2133-12" tabindex="-1"></a></span>
<span id="cb2133-13"><a href="anomaly-detection.html#cb2133-13" tabindex="-1"></a><span class="co"># Create model for Pr comp</span></span>
<span id="cb2133-14"><a href="anomaly-detection.html#cb2133-14" tabindex="-1"></a>iso_model <span class="ot">&lt;-</span> <span class="fu">iForest</span>(df_grid, <span class="at">nt =</span> <span class="dv">100</span>, <span class="at">phi =</span> <span class="dv">100</span>)</span>
<span id="cb2133-15"><a href="anomaly-detection.html#cb2133-15" tabindex="-1"></a><span class="co"># append scores</span></span>
<span id="cb2133-16"><a href="anomaly-detection.html#cb2133-16" tabindex="-1"></a>my_grid<span class="sc">$</span>scores <span class="ot">&lt;-</span> <span class="fu">predict</span>(iso_model, my_grid)</span>
<span id="cb2133-17"><a href="anomaly-detection.html#cb2133-17" tabindex="-1"></a></span>
<span id="cb2133-18"><a href="anomaly-detection.html#cb2133-18" tabindex="-1"></a><span class="co"># Draw Plot</span></span>
<span id="cb2133-19"><a href="anomaly-detection.html#cb2133-19" tabindex="-1"></a><span class="fu">library</span>(lattice)</span>
<span id="cb2133-20"><a href="anomaly-detection.html#cb2133-20" tabindex="-1"></a><span class="fu">contourplot</span>(scores <span class="sc">~</span> PC1 <span class="sc">+</span> PC2, <span class="at">data =</span> my_grid, <span class="at">region =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an16"></span>
<img src="DauR_files/figure-html/an16-1.png" alt="Contour Plot" width="90%" />
<p class="caption">
Figure 40.12: Contour Plot
</p>
</div>
<p><strong>Including categorical variables</strong> One benefit of using forest tree method of anomaly detection, is that we can include categorical values also. Only condition is that these should be of <code>factor</code> type.</p>
<p><strong>Problem Statement-2:</strong> Let’s now try to find out anomalies on full <code>iris</code> data. We can check column types before proceeding.</p>
<div class="sourceCode" id="cb2134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2134-1"><a href="anomaly-detection.html#cb2134-1" tabindex="-1"></a><span class="fu">sapply</span>(iris, class)</span></code></pre></div>
<pre><code>## Sepal.Length  Sepal.Width Petal.Length  Petal.Width      Species 
##    &quot;numeric&quot;    &quot;numeric&quot;    &quot;numeric&quot;    &quot;numeric&quot;     &quot;factor&quot;</code></pre>
<p>Our condition is met. So we can proceed directly to build a decision tree/Forest. For sake of simplicity, let’s build a simple tree (one). Refer Figure <a href="anomaly-detection.html#fig:an18">40.13</a>.</p>
<div class="sourceCode" id="cb2136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2136-1"><a href="anomaly-detection.html#cb2136-1" tabindex="-1"></a><span class="co"># New Iforest Model</span></span>
<span id="cb2136-2"><a href="anomaly-detection.html#cb2136-2" tabindex="-1"></a>iso_model_new <span class="ot">&lt;-</span> <span class="fu">iForest</span>(iris, <span class="at">nt =</span> <span class="dv">1</span>, <span class="at">phi =</span> <span class="dv">100</span>)</span>
<span id="cb2136-3"><a href="anomaly-detection.html#cb2136-3" tabindex="-1"></a>new_scores <span class="ot">&lt;-</span> <span class="fu">predict</span>(iso_model_new, iris)</span>
<span id="cb2136-4"><a href="anomaly-detection.html#cb2136-4" tabindex="-1"></a><span class="fu">head</span>(new_scores)</span></code></pre></div>
<pre><code>## [1] 0.3687105 0.3687105 0.3687105 0.3687105 0.3687105 0.6607827</code></pre>
<div class="sourceCode" id="cb2138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2138-1"><a href="anomaly-detection.html#cb2138-1" tabindex="-1"></a><span class="co"># Full PRCOMP for Visual</span></span>
<span id="cb2138-2"><a href="anomaly-detection.html#cb2138-2" tabindex="-1"></a>iris_pr <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(iris[, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb2138-3"><a href="anomaly-detection.html#cb2138-3" tabindex="-1"></a></span>
<span id="cb2138-4"><a href="anomaly-detection.html#cb2138-4" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb2138-5"><a href="anomaly-detection.html#cb2138-5" tabindex="-1"></a>  <span class="at">PC1 =</span> iris_pr<span class="sc">$</span>x[,<span class="dv">1</span>],</span>
<span id="cb2138-6"><a href="anomaly-detection.html#cb2138-6" tabindex="-1"></a>  <span class="at">PC2 =</span> iris_pr<span class="sc">$</span>x[,<span class="dv">2</span>]</span>
<span id="cb2138-7"><a href="anomaly-detection.html#cb2138-7" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb2138-8"><a href="anomaly-detection.html#cb2138-8" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">score =</span> new_scores,</span>
<span id="cb2138-9"><a href="anomaly-detection.html#cb2138-9" tabindex="-1"></a>         <span class="at">Species =</span> iris<span class="sc">$</span>Species) <span class="sc">%&gt;%</span> </span>
<span id="cb2138-10"><a href="anomaly-detection.html#cb2138-10" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(PC1, PC2, <span class="at">color =</span> Species)) <span class="sc">+</span></span>
<span id="cb2138-11"><a href="anomaly-detection.html#cb2138-11" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> score)) <span class="sc">+</span></span>
<span id="cb2138-12"><a href="anomaly-detection.html#cb2138-12" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">size =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb2138-13"><a href="anomaly-detection.html#cb2138-13" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb2138-14"><a href="anomaly-detection.html#cb2138-14" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Decision Tree</span><span class="sc">\n</span><span class="st">Visualised on Principal Components&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an18"></span>
<img src="DauR_files/figure-html/an18-1.png" alt="Including categorical variable" width="98%" />
<p class="caption">
Figure 40.13: Including categorical variable
</p>
</div>
</div>
<div id="including-categorical-variables-in-lof" class="section level2" number="40.8">
<h2><span class="header-section-number">40.8</span> Including categorical variables in LOF</h2>
<p>We can also include categorical variable in <code>Local outlier factor</code> using <code>gower distance</code> calculation method. Gower method lets us calculate distance between categorical observations, most importantly when the categories are not ordered. To calculate it we can use function <code>daisy</code> from library <code>cluster</code> in R. Let’s see LOF score calculation on the above example. The plot generated can be seen in Figure <a href="anomaly-detection.html#fig:an20">40.14</a>.</p>
<div class="sourceCode" id="cb2139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2139-1"><a href="anomaly-detection.html#cb2139-1" tabindex="-1"></a><span class="fu">library</span>(cluster)</span>
<span id="cb2139-2"><a href="anomaly-detection.html#cb2139-2" tabindex="-1"></a>iris_dist <span class="ot">&lt;-</span> <span class="fu">daisy</span>(iris, <span class="at">metric =</span> <span class="st">&quot;gower&quot;</span>)</span>
<span id="cb2139-3"><a href="anomaly-detection.html#cb2139-3" tabindex="-1"></a>iris_lof <span class="ot">&lt;-</span> <span class="fu">lof</span>(iris_dist, <span class="at">minPts =</span> <span class="dv">5</span>)</span>
<span id="cb2139-4"><a href="anomaly-detection.html#cb2139-4" tabindex="-1"></a></span>
<span id="cb2139-5"><a href="anomaly-detection.html#cb2139-5" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb2139-6"><a href="anomaly-detection.html#cb2139-6" tabindex="-1"></a>  <span class="at">PC1 =</span> iris_pr<span class="sc">$</span>x[,<span class="dv">1</span>],</span>
<span id="cb2139-7"><a href="anomaly-detection.html#cb2139-7" tabindex="-1"></a>  <span class="at">PC2 =</span> iris_pr<span class="sc">$</span>x[,<span class="dv">2</span>]</span>
<span id="cb2139-8"><a href="anomaly-detection.html#cb2139-8" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb2139-9"><a href="anomaly-detection.html#cb2139-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">score =</span> iris_lof,</span>
<span id="cb2139-10"><a href="anomaly-detection.html#cb2139-10" tabindex="-1"></a>         <span class="at">Species =</span> iris<span class="sc">$</span>Species) <span class="sc">%&gt;%</span> </span>
<span id="cb2139-11"><a href="anomaly-detection.html#cb2139-11" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(PC1, PC2, <span class="at">color =</span> Species)) <span class="sc">+</span></span>
<span id="cb2139-12"><a href="anomaly-detection.html#cb2139-12" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> score)) <span class="sc">+</span></span>
<span id="cb2139-13"><a href="anomaly-detection.html#cb2139-13" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">size =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb2139-14"><a href="anomaly-detection.html#cb2139-14" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb2139-15"><a href="anomaly-detection.html#cb2139-15" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;LOF Scores</span><span class="sc">\n</span><span class="st">Visualised on Principal Components&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an20"></span>
<img src="DauR_files/figure-html/an20-1.png" alt="Including categorical variable" width="90%" />
<p class="caption">
Figure 40.14: Including categorical variable
</p>
</div>
</div>
<div id="time-series-anomalies" class="section level2" number="40.9">
<h2><span class="header-section-number">40.9</span> Time Series Anomalies</h2>
<p>In time series data, an anomaly/outlier can be termed as a data point which is not following the common collective trend or seasonal or cyclic pattern of the entire data and is significantly distinct from rest of the data.</p>
<p>To calculate/detect anomalies, in R, we make use of package <code>timetk</code>. The package works on <code>tibble</code> instead of <code>time series</code> data, so we may to prep our data/time series accordingly.</p>
<p><strong>Problem Statement</strong> Let’s find out anomalies, if any on Sunspots data available in base R<a href="#fn46" class="footnote-ref" id="fnref46"><sup>46</sup></a>.</p>
<div class="sourceCode" id="cb2140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2140-1"><a href="anomaly-detection.html#cb2140-1" tabindex="-1"></a>start_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">&quot;1749-01-01&quot;</span>)</span>
<span id="cb2140-2"><a href="anomaly-detection.html#cb2140-2" tabindex="-1"></a>end_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">&quot;2013-09-01&quot;</span>)</span>
<span id="cb2140-3"><a href="anomaly-detection.html#cb2140-3" tabindex="-1"></a>date_sequence <span class="ot">&lt;-</span> <span class="fu">seq</span>(start_date, end_date, <span class="at">by =</span> <span class="st">&quot;months&quot;</span>)</span>
<span id="cb2140-4"><a href="anomaly-detection.html#cb2140-4" tabindex="-1"></a></span>
<span id="cb2140-5"><a href="anomaly-detection.html#cb2140-5" tabindex="-1"></a>sunspot_df <span class="ot">&lt;-</span> sunspot.month <span class="sc">%&gt;%</span></span>
<span id="cb2140-6"><a href="anomaly-detection.html#cb2140-6" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2140-7"><a href="anomaly-detection.html#cb2140-7" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="st">&quot;value&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2140-8"><a href="anomaly-detection.html#cb2140-8" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> date_sequence)</span>
<span id="cb2140-9"><a href="anomaly-detection.html#cb2140-9" tabindex="-1"></a></span>
<span id="cb2140-10"><a href="anomaly-detection.html#cb2140-10" tabindex="-1"></a><span class="fu">library</span>(timetk)</span>
<span id="cb2140-11"><a href="anomaly-detection.html#cb2140-11" tabindex="-1"></a>sunspot_df <span class="sc">%&gt;%</span> </span>
<span id="cb2140-12"><a href="anomaly-detection.html#cb2140-12" tabindex="-1"></a>  <span class="fu">plot_anomaly_diagnostics</span>(date, value,</span>
<span id="cb2140-13"><a href="anomaly-detection.html#cb2140-13" tabindex="-1"></a>                           <span class="at">.interactive =</span> <span class="cn">FALSE</span>) </span>
<span id="cb2140-14"><a href="anomaly-detection.html#cb2140-14" tabindex="-1"></a></span>
<span id="cb2140-15"><a href="anomaly-detection.html#cb2140-15" tabindex="-1"></a>sunspot_df <span class="sc">%&gt;%</span> </span>
<span id="cb2140-16"><a href="anomaly-detection.html#cb2140-16" tabindex="-1"></a>  <span class="fu">tk_anomaly_diagnostics</span>(date, value) <span class="sc">%&gt;%</span> </span>
<span id="cb2140-17"><a href="anomaly-detection.html#cb2140-17" tabindex="-1"></a>  <span class="fu">filter</span>(anomaly <span class="sc">==</span> <span class="st">&#39;Yes&#39;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 37 × 11
##    date       observed season trend remainder seasadj remainder_l1 remainder_l2
##    &lt;date&gt;        &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;
##  1 1749-11-01     159. -1.07   76.3      83.4    160.        -64.8         66.7
##  2 1769-09-01     149. -0.524  78.8      70.5    149.        -64.8         66.7
##  3 1769-10-01     158.  1.17   79.3      77.7    157.        -64.8         66.7
##  4 1769-11-01     148. -1.07   79.8      69.4    149.        -64.8         66.7
##  5 1771-05-01     153.  0.963  77.5      74.3    152.        -64.8         66.7
##  6 1777-11-01     146  -1.07   75.7      71.4    147.        -64.8         66.7
##  7 1777-12-01     157. -0.495  77.8      80.0    158.        -64.8         66.7
##  8 1778-01-01     177. -2.18   79.9      99.6    179.        -64.8         66.7
##  9 1778-05-01     239.  0.963  87.3     151.     238.        -64.8         66.7
## 10 1778-06-01     172.  0.368  89.2      82.1    171.        -64.8         66.7
## # ℹ 27 more rows
## # ℹ 3 more variables: anomaly &lt;chr&gt;, recomposed_l1 &lt;dbl&gt;, recomposed_l2 &lt;dbl&gt;</code></pre>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:an17"></span>
<img src="DauR_files/figure-html/an17-1.png" alt="Time Series Anomalies" width="90%" />
<p class="caption">
Figure 40.15: Time Series Anomalies
</p>
</div>
<p>We can anomalies highlighted in red, in Figure <a href="anomaly-detection.html#fig:an17">40.15</a> and anomalies filtered out in code above. We may also implement Seasonal Hybrid ESD algorithm already discussed above.</p>

</div>
</div>
<div class="footnotes">
<hr />
<ol start="46">
<li id="fn46"><p>Monthly numbers of sunspots, as from the World Data Center, aka SIDC. This is the version of the data that will occasionally be updated when new counts become available.<a href="anomaly-detection.html#fnref46" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </main>

  <div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page">
      <h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          <li><a id="book-source" href="#">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="#">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
      </div>
    </nav>
  </div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5">
  <div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R for Audit Analytics</strong>" was written by Anil Goyal. It was last built on 2024-11-29.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
<script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>

</html>
