<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Chapter 11 Merging large number of similar datasets into one | R for Audit Analytics</title>

    <meta name="author" content="Anil Goyal" />
  
   <meta name="description" content="This book is intended for auditors performing exploratory data analytics using R programming language, mainly Base R and Tidyverse." />
   <meta name="generator" content="placeholder" />
  <meta property="og:title" content="Chapter 11 Merging large number of similar datasets into one | R for Audit Analytics" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://anilyayavar.github.io/new-book/" />
  <meta property="og:image" content="https://anilyayavar.github.io/new-book/images/cover.jpg" />
  <meta property="og:description" content="This book is intended for auditors performing exploratory data analytics using R programming language, mainly Base R and Tidyverse." />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 11 Merging large number of similar datasets into one | R for Audit Analytics" />
  
  <meta name="twitter:description" content="This book is intended for auditors performing exploratory data analytics using R programming language, mainly Base R and Tidyverse." />
  <meta name="twitter:image" content="https://anilyayavar.github.io/new-book/images/cover.jpg" />
  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet" />
    <script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script>
    <script src="libs/bs3compat-0.8.0/transition.js"></script>
    <script src="libs/bs3compat-0.8.0/tabs.js"></script>
    <script src="libs/bs3compat-0.8.0/bs3compat.js"></script>
    <link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet" />
    <script src="libs/bs4_book-1.0.0/bs4_book.js"></script>
    <script src="libs/kePrint-0.0.1/kePrint.js"></script>
    <link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script>

  <!-- CSS -->
  <style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
    <style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
          margin-bottom: 0em;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
      <link rel="stylesheet" href="style.css" />
  
</head>

<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book">
    <a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R for Audit Analytics</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
      </form>

      <nav aria-label="Table of contents">
        <h2>Table of contents</h2>
        <div id="book-toc"></div>

        <div class="book-extra">
          <p><a id="book-repo" href="#">View book source <i class="fab fa-github"></i></a></li></p>
        </div>
      </nav>
    </div>
  </header>

  <main class="col-sm-12 col-md-9 col-lg-7" id="content">
<div id="merging-large-number-of-similar-datasets-into-one" class="section level1" number="11">
<h1><span class="header-section-number">Chapter 11</span> Merging large number of similar datasets into one</h1>
<p>Data preparation for performing analytics is an important task and may require more time than actual analytics because we rarely have data in ideal format. Importing csv or flat files is rather an easy job. However, considering large popularity of MS Excel, we at times have our data saved in excel files.</p>
<p>Sometimes, one single data frame/table is divided into multiple sheets in one excel file whereas sometimes these tables are divided in multiple files. Here we are discussing few of these cases, where we can reduce our data preparation time by effectively writing the code for import of such data into our environment.</p>
<div id="case-1-merging-multiple-excel-sheets-into-one-data-frame" class="section level2" number="11.1">
<h2><span class="header-section-number">11.1</span> <strong>Case-1</strong>: Merging multiple excel sheets into one data frame</h2>
<p>As an example, let’s say we have multiple States’ data saved on a different sheet in one excel file say <code>Daur.xlsx</code>. See preview in fig <a href="merging-large-number-of-similar-datasets-into-one.html#fig:prevexcel">11.1</a>.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:prevexcel"></span>
<img src="images/excel.png" alt="Preview of example excel file" width="100%" />
<p class="caption">
Figure 11.1: Preview of example excel file
</p>
</div>
<p>We will use library <code>readxl</code> to read excel files. This library is bundled with <code>tidyverse</code> but is not part of core tidyverse, so it has to be loaded explicitly, though explicit download is not required if <code>tidyverse</code> is installed in the system.</p>
<div class="sourceCode" id="cb741"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb741-1"><a href="merging-large-number-of-similar-datasets-into-one.html#cb741-1" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb741-2"><a href="merging-large-number-of-similar-datasets-into-one.html#cb741-2" tabindex="-1"></a><span class="fu">library</span>(readxl)</span></code></pre></div>
<p>The following steps are used-</p>
<p>Step-1: Read path</p>
<p>Step-2: Collect Names of all sheets</p>
<p>Step-3: Set names of elements of above vector onto itself</p>
<p>Step-4: Read and combine all tables into one. We will use <code>purrr::map_dfr</code> for this.</p>
<div class="sourceCode" id="cb742"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb742-1"><a href="merging-large-number-of-similar-datasets-into-one.html#cb742-1" tabindex="-1"></a><span class="co"># Step-1</span></span>
<span id="cb742-2"><a href="merging-large-number-of-similar-datasets-into-one.html#cb742-2" tabindex="-1"></a>path <span class="ot">&lt;-</span> <span class="st">&quot;data/daur1.xlsx&quot;</span></span>
<span id="cb742-3"><a href="merging-large-number-of-similar-datasets-into-one.html#cb742-3" tabindex="-1"></a><span class="co"># Step-2</span></span>
<span id="cb742-4"><a href="merging-large-number-of-similar-datasets-into-one.html#cb742-4" tabindex="-1"></a>states_data <span class="ot">&lt;-</span> <span class="fu">excel_sheets</span>(path) <span class="sc">%&gt;%</span> </span>
<span id="cb742-5"><a href="merging-large-number-of-similar-datasets-into-one.html#cb742-5" tabindex="-1"></a><span class="co"># step-3</span></span>
<span id="cb742-6"><a href="merging-large-number-of-similar-datasets-into-one.html#cb742-6" tabindex="-1"></a>    <span class="fu">set_names</span>(., .) <span class="sc">%&gt;%</span> </span>
<span id="cb742-7"><a href="merging-large-number-of-similar-datasets-into-one.html#cb742-7" tabindex="-1"></a><span class="co"># step-4</span></span>
<span id="cb742-8"><a href="merging-large-number-of-similar-datasets-into-one.html#cb742-8" tabindex="-1"></a>    <span class="fu">map_dfr</span>(read_excel, <span class="at">path=</span>path, <span class="at">.id =</span> <span class="st">&#39;State_name&#39;</span>)</span>
<span id="cb742-9"><a href="merging-large-number-of-similar-datasets-into-one.html#cb742-9" tabindex="-1"></a><span class="co"># print file</span></span>
<span id="cb742-10"><a href="merging-large-number-of-similar-datasets-into-one.html#cb742-10" tabindex="-1"></a>states_data</span></code></pre></div>
<pre><code>## # A tibble: 18 × 4
##    State_name     Year    Metric_1 Metric_2
##    &lt;chr&gt;          &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;
##  1 Andhra Pradesh 2015-16      119      121
##  2 Andhra Pradesh 2016-17      114      134
##  3 Andhra Pradesh 2017-18      115      122
##  4 Andhra Pradesh 2018-19      129      137
##  5 Andhra Pradesh 2019-20      149      129
##  6 Andhra Pradesh 2020-21      104      124
##  7 Assam          2015-16      104      145
##  8 Assam          2016-17      114      144
##  9 Assam          2017-18      116      116
## 10 Assam          2018-19      129      130
## 11 Assam          2019-20      144      134
## 12 Assam          2020-21      124      116
## 13 Bihar          2015-16      109      148
## 14 Bihar          2016-17      134      106
## 15 Bihar          2017-18      131      133
## 16 Bihar          2018-19      131      100
## 17 Bihar          2019-20      131      127
## 18 Bihar          2020-21      128      103</code></pre>
<p>We can see that data from all the sheets have been merged into table and one extra column has been created using sheet name. The name of that column has been provided through <code>.id</code> argument. If the new column is not required, simply don’t use this argument.</p>
</div>
<div id="case-2-merging-multiple-files-into-one-data-frame" class="section level2" number="11.2">
<h2><span class="header-section-number">11.2</span> <strong>Case-2</strong>: Merging multiple files into one data frame</h2>
<p>Often we have our source data split into multiple files, which we will have to compile in one single data frame before proceeding In this case, we may collect all such files in one directory and follow these steps-</p>
<p>Step-1: Store all file names using <code>list.files()</code></p>
<p>Step-2: We may read all files in one list using either <code>lapply</code> or <code>purrr::map</code>.</p>
<p>Step-3: If data structures in all the files are same, we can directly use <code>purrr::map_dfr</code> which will read all files and give us a data frame. If however, the structure of data in all files are not same, we may convert all columns into character type before merging these files. We can thereafter proceed for merging all data using either <code>purrr::map_dfr</code> or <code>lapply</code> in combination with <code>do.call</code>.</p>
</div>
<div id="case-3-split-and-save-one-data-frame-into-multiple-excelcsv-files-simultaneously." class="section level2" number="11.3">
<h2><span class="header-section-number">11.3</span> <strong>Case-3</strong>: Split and save one data frame into multiple excel/csv files simultaneously.</h2>
<p>As an example will use <code>states_data</code> created in case-1. We can use the following algorithm</p>
<p>Step-1: Create a vector of file names using <code>paste0</code>
Step-2: Split data frame into a list with separate dataframe for each state
Step-3: Write to a separate file using <code>purrr::walk2()</code></p>
<p>The complete algorithm is</p>
<div class="sourceCode" id="cb744"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb744-1"><a href="merging-large-number-of-similar-datasets-into-one.html#cb744-1" tabindex="-1"></a><span class="co"># step-1 : create a vector of file names (output)</span></span>
<span id="cb744-2"><a href="merging-large-number-of-similar-datasets-into-one.html#cb744-2" tabindex="-1"></a>file_names <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;data/&quot;</span>, <span class="fu">unique</span>(states_data<span class="sc">$</span>State_name), <span class="st">&quot;.csv&quot;</span>)</span>
<span id="cb744-3"><a href="merging-large-number-of-similar-datasets-into-one.html#cb744-3" tabindex="-1"></a></span>
<span id="cb744-4"><a href="merging-large-number-of-similar-datasets-into-one.html#cb744-4" tabindex="-1"></a>states_data <span class="sc">%&gt;%</span> </span>
<span id="cb744-5"><a href="merging-large-number-of-similar-datasets-into-one.html#cb744-5" tabindex="-1"></a>  <span class="fu">group_split</span>(State_name) <span class="sc">%&gt;%</span> </span>
<span id="cb744-6"><a href="merging-large-number-of-similar-datasets-into-one.html#cb744-6" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">walk2</span>(file_names, write.csv)</span></code></pre></div>
<p>We can check that 3 new files with state_names as filenames have been created in the <code>data</code> folder/directory as desired.</p>
</div>
<div id="case-4-splitting-one-data-into-muliple-files-having-multiple-sheets" class="section level2" number="11.4">
<h2><span class="header-section-number">11.4</span> <strong>Case-4</strong>: Splitting one data into muliple files having multiple sheets</h2>
<p>Sometimes, we may require to split a file not only into multiple files, but simultaeously require to split each file into multiple excel sheets. E.g. A data having States and districts is to be split into State-wise files having a separate sheet for each district.</p>
<p>This can be achieved using <code>writexl</code> library. In this case, we may write a custom function which can do our job easily.</p>
<div class="sourceCode" id="cb745"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb745-1"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-1" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb745-2"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-2" tabindex="-1"></a><span class="fu">library</span>(writexl)</span>
<span id="cb745-3"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-3" tabindex="-1"></a></span>
<span id="cb745-4"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-4" tabindex="-1"></a>book_and_sheets <span class="ot">&lt;-</span> <span class="cf">function</span>(df, x, y){</span>
<span id="cb745-5"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-5" tabindex="-1"></a>  df_by_x <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb745-6"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-6" tabindex="-1"></a>    <span class="fu">split</span>(.[[x]])</span>
<span id="cb745-7"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-7" tabindex="-1"></a>  </span>
<span id="cb745-8"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-8" tabindex="-1"></a>  save_to_excel <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b){</span>
<span id="cb745-9"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-9" tabindex="-1"></a>    a <span class="sc">%&gt;%</span> </span>
<span id="cb745-10"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-10" tabindex="-1"></a>      <span class="fu">split</span>(.[[y]]) <span class="sc">%&gt;%</span> </span>
<span id="cb745-11"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-11" tabindex="-1"></a>      writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(</span>
<span id="cb745-12"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-12" tabindex="-1"></a>        <span class="at">path =</span> <span class="fu">paste0</span>(<span class="st">&quot;data/data_by_&quot;</span>, b,<span class="st">&quot;_&quot;</span>,x, <span class="st">&quot;.xlsx&quot;</span>)</span>
<span id="cb745-13"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-13" tabindex="-1"></a>      )</span>
<span id="cb745-14"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-14" tabindex="-1"></a>    </span>
<span id="cb745-15"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-15" tabindex="-1"></a>  }</span>
<span id="cb745-16"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-16" tabindex="-1"></a>  </span>
<span id="cb745-17"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-17" tabindex="-1"></a>  <span class="fu">imap</span>(df_by_x, save_to_excel)</span>
<span id="cb745-18"><a href="merging-large-number-of-similar-datasets-into-one.html#cb745-18" tabindex="-1"></a>}</span></code></pre></div>
<p>The function <code>book_and_sheets</code> designed in above code helps us to write a data say <code>df</code> into separate files based on column <code>x</code> and each of these files is further divided into sheets based on column <code>y</code>. Only thing to be remembered is that we have to pass, <code>x</code> and <code>y</code> arguments as character strings; and <code>df</code> as variable.</p>
<p>Example - splitting <code>mtcars</code> into files based on <code>cyl</code> and sheets based on <code>gear</code></p>
<div class="sourceCode" id="cb746"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb746-1"><a href="merging-large-number-of-similar-datasets-into-one.html#cb746-1" tabindex="-1"></a><span class="fu">book_and_sheets</span>(mtcars, <span class="st">&#39;cyl&#39;</span>, <span class="st">&#39;gear&#39;</span>)</span></code></pre></div>
<pre><code>## $`4`
## [1] &quot;G:\\OneDrive - A c GeM CAG of INDIA (1)\\new book\\Data\\data_by_4_cyl.xlsx&quot;
## 
## $`6`
## [1] &quot;G:\\OneDrive - A c GeM CAG of INDIA (1)\\new book\\Data\\data_by_6_cyl.xlsx&quot;
## 
## $`8`
## [1] &quot;G:\\OneDrive - A c GeM CAG of INDIA (1)\\new book\\Data\\data_by_8_cyl.xlsx&quot;</code></pre>
<p>We can check that three excel files have been created in directory <code>data/</code>.</p>

</div>
</div>
  </main>

  <div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page">
      <h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          <li><a id="book-source" href="#">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="#">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
      </div>
    </nav>
  </div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5">
  <div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R for Audit Analytics</strong>" was written by Anil Goyal. It was last built on 2024-11-29.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
<script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>

</html>
